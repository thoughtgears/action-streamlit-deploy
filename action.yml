name: Streamlit Deploy
description: Deploy streamlit to Cloud Run
inputs:
  terraform-version:
    description: The version of Terraform to use
    default: 1.8.5
  terraform_directory:
    description: The directory containing the Terraform configuration
    default: terraform
  region:
    description: GCP Region to deploy to
    default: europe-west1
  project:
    description: GCP Project to deploy to
    required: true
  github_token:
    description: GitHub token to use in the action for different steps
    required: true

outputs:
  cloud_run_url:
    description: The URL of the deployed Cloud Run streamlit app
    value: ${{ steps.random-number-generator.outputs.random-number }}

runs:
  using: composite

  steps:
    - name: Setup Terraform
      id: setup-terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Get Last Successful Run
      id: get-last-run
      shell: bash
      run: |
        response=$(curl -s -H "Authorization: token ${{ inputs.github_token }}" \
                         -H "Accept: application/vnd.github.v3+json" \
                         "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/runs?status=success&per_page=1")
        
        run_id=$(echo "$response" | jq -r '.workflow_runs[0].id')
        
        if [ "$run_id" == "null" ]; then
          echo "No successful runs found for workflow: ${{ github.workflow }}"
          exit 1
        fi
        
        echo "run_id=$run_id" >> $GITHUB_ENV


    - name: Download Terraform State Artifact
      id: download-artifact
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: terraform.tfstate
        path: ${{ inputs.terraform_directory }}
        run-id: ${{ env.run_id }}

    - name: Terraform Run
      id: terraform-run
      shell: bash
      run: |
        terraform init
        terraform validate
        terraform plan -out=tf.plan --var region=${{ inputs.region }} --var project_id=${{ inputs.project }}
        terraform apply tf.plan
      working-directory: ${{ inputs.terraform_directory }}

    - name: Upload Terraform State Artifact
      id: upload-artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform.tfstate
        path: ${{ inputs.terraform_directory }}/terraform.tfstate
        retention-days: 90
